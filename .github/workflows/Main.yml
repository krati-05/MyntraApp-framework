name: Main branch CI

on:  
   push:
     branches: [ main ]

env:
  ARTIFACT_NAME: drop
  
jobs:  
   build:    
     runs-on: dotnet

     steps:
     
       - uses: actions/checkout@v2
       
       - name: Setup MSBuild
         uses: microsoft/setup-msbuild@v1

         
       - name: Setup NuGet.exe for use with actions
         uses: NuGet/setup-nuget@v2.0.0
         with:
          nuget-version: '5.x'

       - name: Setup VSTest
         uses: darenm/Setup-VSTest@v1

       - name: Restore Packages
         run: nuget restore Myntra/Myntra.sln
         working-directory: ${{ github.workspace }}

       - name: Build solution
         run: msbuild.exe Myntra/Myntra.sln /p:platform="Any CPU" /p:configuration="Release"
         working-directory: ${{ github.workspace }}


       - name: Run Tests
         run: vstest.console.exe .\Myntra.Tests\bin\Release\Myntra.Tests.dll
         
       - name: Prepare artifact staging directory
         run: |
          mkdir -p artifact_output
          cp -r Myntra/tests/Myntra.Tests/bin/Release/* artifact_output/
          
       - name: Publish artifact
         uses: actions/upload-artifact@v3
         with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifact_output/
